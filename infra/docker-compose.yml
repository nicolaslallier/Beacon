services:
  infra-static:
    image: caddy:2.7.6-alpine
    container_name: infra-static
    restart: unless-stopped
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./html:/usr/share/caddy:ro
    networks:
      - nginx_net
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # API Gateway (Traefik + OAuth2 Proxy)
  # ============================================
  infra-traefik:
    image: traefik:v3.0.4
    container_name: infra-traefik
    restart: unless-stopped
    command: ["--configFile=/etc/traefik/traefik.yml"]
    volumes:
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ${SSL_CERTS_PATH:-./certs}:/etc/traefik/certs:ro
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
      - "${TRAEFIK_POSTGRES_PORT:-5432}:5432"
      - "${TRAEFIK_BEACON_VECTORDB_PORT:-${TRAEFIK_VECTORDB_PORT:-5433}}:5433"
      - "${TRAEFIK_POSTGRES_TOOLS_PORT:-5434}:5434"
    expose:
      - "9100"
    networks:
      nginx_net:
        aliases:
          - beacon.famillelallier.net
          - n8n.beacon.famillelallier.net
          - pgadmin.beacon.famillelallier.net
          - postgresql.beacon.famillelallier.net
          - beacon-ollama.beacon.famillelallier.net
          - beacon-tools.db.beacon.famillelallier.net
      monitoring_net: null
      beacon_library_net: null
      beacon_n8n_net: null
      beacon_ollama_net: null
    depends_on:
      - infra-oauth2-proxy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  infra-oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    container_name: infra-oauth2-proxy
    restart: unless-stopped
    env_file:
      - ../config/.env
    environment:
      # Core OAuth2 settings - loaded from env_file, these provide defaults only
      OAUTH2_PROXY_PROVIDER: keycloak-oidc
      OAUTH2_PROXY_OIDC_ISSUER_URL: http://infra-keycloak:8080/realms/beacon
      OAUTH2_PROXY_SKIP_OIDC_DISCOVERY: "true"
      OAUTH2_PROXY_LOGIN_URL: https://keycloak.beacon.famillelallier.net/realms/beacon/protocol/openid-connect/auth
      OAUTH2_PROXY_REDEEM_URL: http://infra-keycloak:8080/realms/beacon/protocol/openid-connect/token
      OAUTH2_PROXY_OIDC_JWKS_URL: http://infra-keycloak:8080/realms/beacon/protocol/openid-connect/certs
      OAUTH2_PROXY_REDIRECT_URL: https://beacon-library.famillelallier.net/oauth2/callback
      OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL: "true"
      OAUTH2_PROXY_INSECURE_OIDC_SKIP_ISSUER_VERIFICATION: "true"
      # Domain and cookie settings
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_WHITELIST_DOMAINS: .famillelallier.net
      OAUTH2_PROXY_COOKIE_DOMAINS: .famillelallier.net
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      # Proxy behavior
      OAUTH2_PROXY_REVERSE_PROXY: "true"
      OAUTH2_PROXY_UPSTREAMS: static://200
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
      OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_PASS_USER_HEADERS: "true"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
    expose:
      - "4180"
    networks:
      - nginx_net
      - keycloak_net

  # ============================================
  # Technitium DNS Server (Ranger DNS GUI)
  # ============================================
  infra-technitium-dns:
    image: technitium/dns-server:14.3.0
    container_name: infra-technitium-dns
    restart: unless-stopped
    env_file:
      - ../config/.env
    networks:
      nginx_net:
        ipv4_address: 172.29.0.53
      monitoring_net: null
      keycloak_net: null
      beacon_library_net: null
    ports:
      - "${TECHNITIUM_DNS_PORT:-53}:53/udp"
      - "${TECHNITIUM_DNS_PORT:-53}:53/tcp"
      - "${TECHNITIUM_WEB_PORT:-5380}:5380/tcp"
    volumes:
      - infra-technitium-data:/etc/dns
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5380/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  # ============================================
  # Keycloak Identity & Access Management
  # ============================================
  infra-keycloak-db:
    image: postgres:16-alpine
    profiles: [auth]
    container_name: infra-keycloak-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${KEYCLOAK_DB_NAME:-keycloak}
      - POSTGRES_USER=${KEYCLOAK_DB_USER:-keycloak}
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
    volumes:
      - infra-keycloak-db-data:/var/lib/postgresql/data
    networks:
      - keycloak_net
      - monitoring_net
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${KEYCLOAK_DB_USER:-keycloak} -d ${KEYCLOAK_DB_NAME:-keycloak}",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  infra-keycloak:
    image: quay.io/keycloak/keycloak:26.2.3
    profiles: [auth]
    container_name: infra-keycloak
    restart: unless-stopped
    depends_on:
      infra-keycloak-db:
        condition: service_healthy
    command: start
    environment:
      # Database configuration
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://infra-keycloak-db:5432/${KEYCLOAK_DB_NAME:-keycloak}
      - KC_DB_USERNAME=${KEYCLOAK_DB_USER:-keycloak}
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
      # Admin credentials
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      # Keycloak 26+ bootstrap admin credentials (keep in sync with KEYCLOAK_ADMIN*)
      - KC_BOOTSTRAP_ADMIN_USERNAME=${KEYCLOAK_ADMIN:-admin}
      - KC_BOOTSTRAP_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      # Proxy configuration (behind NGINX reverse proxy with SSL termination)
      - KC_PROXY=edge
      - KC_PROXY_HEADERS=xforwarded
      - KC_HTTP_ENABLED=true
      # Hostname configuration - tell Keycloak it's accessible via HTTPS
      - KC_HOSTNAME=${KEYCLOAK_HOSTNAME:-keycloak.beacon.famillelallier.net}
      - KC_HOSTNAME_PORT=${KEYCLOAK_HOSTNAME_PORT:-443}
      - KC_HOSTNAME_STRICT=${KEYCLOAK_HOSTNAME_STRICT:-true}
      - KC_HOSTNAME_STRICT_HTTPS=${KEYCLOAK_HOSTNAME_STRICT_HTTPS:-true}
      # Frontend URL (this is what users will access)
      - KC_HOSTNAME_URL=https://${KEYCLOAK_HOSTNAME:-keycloak.beacon.famillelallier.net}
      - KC_HOSTNAME_ADMIN_URL=https://${KEYCLOAK_HOSTNAME:-keycloak.beacon.famillelallier.net}
      # Health and metrics
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
      - KC_HTTP_MANAGEMENT_HOST=0.0.0.0
      - KC_HTTP_MANAGEMENT_PORT=9000
      # Logging
      - KC_LOG_LEVEL=${KEYCLOAK_LOG_LEVEL:-info}
    expose:
      - "8080"
      - "9000"
    networks:
      - keycloak_net
      - nginx_net
      - monitoring_net
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s


volumes:
  infra-keycloak-db-data:
  infra-technitium-data:

networks:
  nginx_net:
    external: true
    name: beacon_nginx_net
  monitoring_net:
    external: true
    name: beacon_monitoring_net
  beacon_library_net:
    external: true
    name: beacon-library_beacon-network
  beacon_n8n_net:
    name: beacon_n8n_net
  beacon_ollama_net:
    external: true
    name: beacon_ollama_net
  keycloak_net:
    name: infra_keycloak_net
  technitium_net:
    name: infra_technitium_net