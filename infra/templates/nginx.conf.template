user  nginx;
worker_processes  auto;

error_log  /dev/stderr warn;
pid        /var/run/nginx.pid;

events { worker_connections 1024; }

# ============================================================
#  NGINX — beacon + n8n + pgadmin (subdomains) + same-origin health
#
#  - Default (80/443): drop all other hosts (return 444)
#  - beacon.famillelallier.net:
#      * 80  -> 301 to https
#      * 443 -> static site from /usr/share/nginx/html (index.html)
#      * /_health/n8n     -> proxy to http://n8n-nginx/healthz
#      * /_health/pgadmin -> proxy to http://pgadmin:80/misc/ping
#  - n8n.beacon.famillelallier.net:
#      * 80  -> 301 to https
#      * 443 -> reverse proxy to http://n8n-nginx
#      * allows embedding from https://beacon.famillelallier.net
#  - pgadmin.beacon.famillelallier.net:
#      * 80  -> 301 to https
#      * 443 -> reverse proxy to http://pgadmin:80
#      * allows embedding from https://beacon.famillelallier.net (if you iframe it later)
#
#  TLS:
#    ssl_certificate     ${SSL_CERT_PATH}
#    ssl_certificate_key ${SSL_KEY_PATH}
# ============================================================

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    access_log /dev/stdout;
    error_log  /dev/stderr warn;

    # WebSocket support
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # ------------------------------------------------------------
    # Default catch-all: drop anything not explicitly matching
    # ------------------------------------------------------------
    server {
        listen 80 default_server;
        server_name _;
        return 444;
    }

    server {
        listen 443 ssl default_server;
        http2 on;
        server_name _;

        ssl_certificate     ${SSL_CERT_PATH};
        ssl_certificate_key ${SSL_KEY_PATH};

        return 444;
    }

    # ------------------------------------------------------------
    # beacon.famillelallier.net — HTTP -> HTTPS
    # ------------------------------------------------------------
    server {
        listen 80;
        server_name beacon.famillelallier.net;
        return 301 https://$host$request_uri;
    }

    # ------------------------------------------------------------
    # beacon.famillelallier.net — HTTPS static site + same-origin health
    # ------------------------------------------------------------
    server {
        listen 443 ssl;
        http2 on;
        server_name beacon.famillelallier.net;

        ssl_certificate     ${SSL_CERT_PATH};
        ssl_certificate_key ${SSL_KEY_PATH};
        ssl_protocols       TLSv1.2 TLSv1.3;

        # Docker DNS resolver for dynamic upstreams
        resolver 127.0.0.11 valid=10s;

        root  /usr/share/nginx/html;
        index index.html;

        # Beacon health (static site)
        location = /healthz {
            default_type text/plain;
            return 200 "OK\n";
        }

        # ------------------------------------------------------------
        # Same-origin health endpoints (avoid CORS in browser)
        # ------------------------------------------------------------

        location = /_health/n8n {
            proxy_pass http://n8n-nginx/healthz;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /_health/pgadmin {
            proxy_pass http://pgadmin:80/misc/ping;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /_health/grafana {
            proxy_pass http://grafana-nginx/healthz;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /_health/dns {
            proxy_pass http://technitium-dns:5380/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /_health/beacon-ollama {
            set $beacon_ollama_upstream "beacon-ollama-nginx";
            proxy_pass http://$beacon_ollama_upstream/healthz-beacon-ollama;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /_health/beacon-ollama-webui {
            set $beacon_ollama_upstream "beacon-ollama-nginx";
            proxy_pass http://$beacon_ollama_upstream/healthz-beacon-ollama-webui;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /beacon-ollama-webui/ {
            set $beacon_ollama_upstream "beacon-ollama-nginx";
            proxy_pass http://$beacon_ollama_upstream/beacon-ollama-webui/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;
        }

        location ^~ /_app/ {
            set $beacon_ollama_upstream "beacon-ollama-nginx";
            proxy_pass http://$beacon_ollama_upstream/_app/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;
        }

        location ^~ /static/ {
            set $beacon_ollama_upstream "beacon-ollama-nginx";
            proxy_pass http://$beacon_ollama_upstream/static/;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /manifest.json {
            set $beacon_ollama_upstream "beacon-ollama-nginx";
            proxy_pass http://$beacon_ollama_upstream/manifest.json;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Static site fallback
        location / {
            try_files $uri $uri/ =404;
        }
    }

    # ------------------------------------------------------------
    # n8n.beacon.famillelallier.net — HTTP -> HTTPS
    # ------------------------------------------------------------
    server {
        listen 80;
        server_name n8n.beacon.famillelallier.net;
        return 301 https://$host$request_uri;
    }

    # ------------------------------------------------------------
    # n8n.beacon.famillelallier.net — HTTPS reverse proxy to n8n
    # ------------------------------------------------------------
    server {
        listen 443 ssl;
        http2 on;
        server_name n8n.beacon.famillelallier.net;

        ssl_certificate     ${SSL_CERT_PATH};
        ssl_certificate_key ${SSL_KEY_PATH};
        ssl_protocols       TLSv1.2 TLSv1.3;

        client_max_body_size 50m;

        location = /healthz {
            proxy_pass http://n8n-nginx/healthz;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://n8n-nginx;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;

            # Allow embedding n8n in an iframe from beacon.famillelallier.net
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            add_header Content-Security-Policy "frame-ancestors 'self' https://beacon.famillelallier.net" always;
        }
    }

    # ------------------------------------------------------------
    # pgadmin.beacon.famillelallier.net — HTTP -> HTTPS
    # ------------------------------------------------------------
    server {
        listen 80;
        server_name pgadmin.beacon.famillelallier.net;
        return 301 https://$host$request_uri;
    }

    # ------------------------------------------------------------
    # pgadmin.beacon.famillelallier.net — HTTPS reverse proxy to pgAdmin
    # ------------------------------------------------------------
    server {
        listen 443 ssl;
        http2 on;
        server_name pgadmin.beacon.famillelallier.net;

        ssl_certificate     ${SSL_CERT_PATH};
        ssl_certificate_key ${SSL_KEY_PATH};
        ssl_protocols       TLSv1.2 TLSv1.3;

        client_max_body_size 50m;

        location = /healthz {
            proxy_pass http://pgadmin:80/misc/ping;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://pgadmin:80;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Allow embedding pgAdmin in an iframe from beacon.famillelallier.net (optional)
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            add_header Content-Security-Policy "frame-ancestors 'self' https://beacon.famillelallier.net" always;

            proxy_redirect off;
        }
    }

    # ------------------------------------------------------------
    # beacon-ollama.beacon.famillelallier.net — HTTP -> HTTPS
    # ------------------------------------------------------------
    server {
        listen 80;
        server_name beacon-ollama.beacon.famillelallier.net;
        return 301 https://$host$request_uri;
    }

    # ------------------------------------------------------------
    # beacon-ollama.beacon.famillelallier.net — HTTPS reverse proxy to Ollama
    # ------------------------------------------------------------
    server {
        listen 443 ssl;
        http2 on;
        server_name beacon-ollama.beacon.famillelallier.net;

        ssl_certificate     ${SSL_CERT_PATH};
        ssl_certificate_key ${SSL_KEY_PATH};
        ssl_protocols       TLSv1.2 TLSv1.3;

        client_max_body_size 50m;

        # Docker DNS resolver for dynamic upstreams
        resolver 127.0.0.11 valid=10s;

        location = /healthz {
            set $beacon_ollama_upstream "beacon-ollama-nginx";
            proxy_pass http://$beacon_ollama_upstream/healthz-beacon-ollama;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            set $beacon_ollama_upstream "beacon-ollama-nginx";
            proxy_pass http://$beacon_ollama_upstream;
            proxy_http_version 1.1;

            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header Upgrade           $http_upgrade;
            proxy_set_header Connection        $connection_upgrade;
        }
    }
}