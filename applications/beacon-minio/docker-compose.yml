services:
  minio1:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: beacon-minio1
    hostname: minio1
    restart: unless-stopped
    command: server http://minio{1...3}/data --console-address ":9001"
    env_file:
      - ./.env
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_PROMETHEUS_AUTH_TYPE=public
      - MINIO_SERVER_URL=${MINIO_SERVER_URL:-http://minio1:9000}
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_REDIRECT_URL:-https://minio.beacon.famillelallier.net/}
    volumes:
      - beacon_minio1-data:/data
    networks:
      - monitoring_net
      - nginx_net
      - minio_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  minio2:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: beacon-minio2
    hostname: minio2
    restart: unless-stopped
    command: server http://minio{1...3}/data --console-address ":9001"
    env_file:
      - ./.env
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_PROMETHEUS_AUTH_TYPE=public
      - MINIO_SERVER_URL=${MINIO_SERVER_URL:-http://minio1:9000}
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_REDIRECT_URL:-https://minio.beacon.famillelallier.net/}
    volumes:
      - beacon_minio2-data:/data
    networks:
      - monitoring_net
      - nginx_net
      - minio_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  minio3:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: beacon-minio3
    hostname: minio3
    restart: unless-stopped
    command: server http://minio{1...3}/data --console-address ":9001"
    env_file:
      - ./.env
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_PROMETHEUS_AUTH_TYPE=public
      - MINIO_SERVER_URL=${MINIO_SERVER_URL:-http://minio1:9000}
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_REDIRECT_URL:-https://minio.beacon.famillelallier.net/}
    volumes:
      - beacon_minio3-data:/data
    networks:
      - monitoring_net
      - nginx_net
      - minio_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  minio-nginx:
    image: nginx:1.27-alpine
    container_name: beacon-minio-nginx
    restart: unless-stopped
    environment:
      - MINIO_SERVER_NAME=${MINIO_SERVER_NAME:-minio.beacon.famillelallier.net}
      - MINIO_S3_UPSTREAM_HOST=${MINIO_S3_UPSTREAM_HOST:-minio1}
      - MINIO_S3_UPSTREAM_PORT=${MINIO_S3_UPSTREAM_PORT:-9000}
      - MINIO_CONSOLE_UPSTREAM_HOST=${MINIO_CONSOLE_UPSTREAM_HOST:-minio1}
      - MINIO_CONSOLE_UPSTREAM_PORT=${MINIO_CONSOLE_UPSTREAM_PORT:-9001}
      - DOLLAR=$$
    expose:
      - "80"
    volumes:
      - ./nginx/default.conf.template:/etc/nginx/templates/default.conf.template:ro
    depends_on:
      minio1:
        condition: service_healthy
    networks:
      - nginx_net
      - minio_net
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  beacon_minio1-data:
    name: beacon_minio1-data
  beacon_minio2-data:
    name: beacon_minio2-data
  beacon_minio3-data:
    name: beacon_minio3-data

networks:
  monitoring_net:
    external: true
    name: beacon_monitoring_net
  nginx_net:
    external: true
    name: beacon_nginx_net
  minio_net:
    external: true
    name: beacon_minio_net
