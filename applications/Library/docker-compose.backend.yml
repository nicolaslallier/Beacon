services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
      target: ${BACKEND_TARGET:-dev}
    container_name: beacon-library-backend
    env_file:
      - path: .env
        required: false
    volumes:
      - ./backend:/app
    environment:
      ENV: ${ENV:-local}
      # Database
      POSTGRES_HOST: beacon-library-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-beacon_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-beacon_password}
      POSTGRES_DB: ${POSTGRES_DB:-beacon_library}
      # MinIO - Connect to Beacon's MinIO cluster
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-beacon-minio1:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_SECURE: ${MINIO_SECURE:-false}
      # Keycloak - Connect to Beacon's Keycloak
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://beacon-keycloak:8080}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-beacon}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-beacon-library}
      ENABLE_AUTH: ${ENABLE_AUTH:-false}  # Disable auth for development by default
      # ChromaDB - Semantic search
      CHROMADB_HOST: beacon-library-chromadb
      CHROMADB_PORT: 8000
      # Ollama - Embeddings
      OLLAMA_HOST: beacon-library-ollama
      OLLAMA_PORT: 11434
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}
      # Gotenberg - Document conversion
      GOTENBERG_URL: http://beacon-library-gotenberg:3000
      # SMTP - Email notifications
      SMTP_HOST: ${SMTP_HOST:-beacon-library-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-false}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-noreply@beacon.local}
      # Observability
      OTLP_ENDPOINT: ${OTLP_ENDPOINT:-http://beacon-library-alloy:4317}
      OTLP_ENABLED: ${OTLP_ENABLED:-true}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    command: ["poetry", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    expose:
      - "8000"
    # Expose MCP API directly for local agents (LM Studio, etc.)
    # This allows agents to connect via HTTP without SSL certificate issues
    ports:
      - "${MCP_PORT:-8200}:8000"
    networks:
      beacon_keycloak_net: {}  # Connect to Beacon's Keycloak network
      beacon_minio_net: {}     # Connect to Beacon's MinIO network
      beacon_library_net:
        aliases:
          - backend
    restart: unless-stopped

networks:
  # External networks from Beacon project
  beacon_keycloak_net:
    external: true
  beacon_minio_net:
    external: true
  beacon_library_net:
    name: beacon-library_beacon-network
    external: true
