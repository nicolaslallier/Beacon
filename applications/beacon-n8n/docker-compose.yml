services:
  n8n:
    image: n8nio/n8n:2.4.6
    container_name: beacon-n8n
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      - N8N_HOST=${N8N_HOST:-n8n.beacon.famillelallier.net}
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-https}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://n8n.beacon.famillelallier.net/}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-https://n8n.beacon.famillelallier.net/}
      - GENERIC_TIMEZONE=${N8N_TIMEZONE:-America/Montreal}
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-change_me}
    dns:
      - ${TECHNITIUM_DNS_IP:-172.29.0.53}
    dns_search:
      - ${TECHNITIUM_DNS_SEARCH:-famillelallier.net}
    expose:
      - "5678"
    volumes:
      - beacon_n8n-data:/home/node/.n8n
    networks:
      - n8n_net
      - nginx_net
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q --spider http://localhost:5678/healthz || exit 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  n8n-nginx:
    image: nginx:1.27-alpine
    container_name: beacon-n8n-nginx
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      - N8N_SERVER_NAME=${N8N_SERVER_NAME:-n8n.beacon.famillelallier.net}
      - N8N_UPSTREAM_HOST=n8n
      - N8N_UPSTREAM_PORT=5678
      - DOLLAR=$$
    dns:
      - ${TECHNITIUM_DNS_IP:-172.29.0.53}
    dns_search:
      - ${TECHNITIUM_DNS_SEARCH:-famillelallier.net}
    expose:
      - "80"
    volumes:
      - ./nginx/default.conf.template:/etc/nginx/templates/default.conf.template:ro
    depends_on:
      - n8n
    networks:
      - n8n_net
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  beacon_n8n-data:

networks:
  n8n_net:
    external: true
    name: beacon_n8n_net
  nginx_net:
    external: true
    name: beacon_nginx_net
